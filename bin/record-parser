#!/usr/bin/env python2
import argparse
import copy
from os import listdir
import os
from os.path import isfile
from os.path import join
import json

from matplotlib import pyplot, rc
from matplotlib.pyplot import legend


font = {'family': 'Nimbus Roman No9 L',
        'weight': 'normal',
        'size': 22}


class Result(object):
    def __init__(self, total_percentage, control_percentage, num_nodes,
                 num_edges, name):
        self.total_percentage = total_percentage
        self.control_percentage = control_percentage
        self.num_nodes = num_nodes
        self.num_edges = num_edges
        self.name = name

    def __gt__(self, other):
        return self.control_percentage > other.control_percentage or (
            self.control_percentage == other.control_percentage and
            self.total_percentage > other.total_percentage)

    def __str__(self):
        return "{'tp': %f, 'cp': %f}" % (
            self.total_percentage, self.control_percentage)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='parse pcap to get stats')
    parser.add_argument('-d', '--stats-dir', action='store', required=True,
                        help='tshark stats file dir')

    args = parser.parse_args()
    files = [fn for fn in next(os.walk(args.stats_dir))[2] if
             fn.endswith('json')]
    results = {}

    for file in files:
        parts = file.split('-')
        if parts[0] == 'ryuo':
            continue
        ryuo_file = "ryuo-%s-%s" % (parts[1], parts[2])
        ryu_data, ryuo_data = None, None
        with open(os.path.join(args.stats_dir, file), 'r') as f:
            ryu_data = json.load(f)
        with open(os.path.join(args.stats_dir, ryuo_file), 'r') as f:
            ryuo_data = json.load(f)
        # Validate Data
        if 0 in ryu_data.values():
            continue
        total_percentage = float(ryuo_data['total_tcp']) / ryu_data[
            'total_tcp'] * 100
        control_percentafe = float(ryuo_data['total_tcp']) / ryu_data[
            'routing_tcp'] * 100
        num_nodes = int(ryu_data['num_nodes'])
        num_edges = int(ryu_data['num_edges'])
        if num_edges not in results:
            results[num_edges] = []
        results[num_edges].append(Result(total_percentage, control_percentafe,
                                         ryu_data['num_nodes'],
                                         ryu_data['num_edges'],
                                         parts[2].split('.')[0]))

    for result_group in results:
        results[result_group] = sorted(results[result_group])

    print [[str(result) for result in result_g] for result_g in
           results.values()]

    rc('font', **font)

    keys = [k for k in sorted(results.keys()) if k < 50]
    pyplot.plot(keys, [results[key][-1].total_percentage for key in keys],
                label='Total')
    pyplot.plot(keys, [results[key][-1].control_percentage for key in keys],
                label='Routing')

    pyplot.axhline(y=100, c='r', ls='--')

    # tcp_ax.set_xlabel('Num Edges')
    pyplot.xlabel('Number of Edges')
    pyplot.ylabel('Percentage of Traffic (%)')
    pyplot.ylim(ymin=0)
    pyplot.xlim(xmin=0)
    pyplot.legend(loc=1)

    pyplot.show()










